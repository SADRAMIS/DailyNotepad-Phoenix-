<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É - –ë–ª–æ–∫–Ω–æ—Ç-–§–µ–Ω–∏–∫—Å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="form-container">
        <div class="form-header">
            <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</h2>
            <p class="text-muted">–ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>
        </div>

        <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <span th:text="${error}">–û—à–∏–±–∫–∞</span>
        </div>

        <form th:action="@{/notes/{id}/update(id=${note.id})}" th:object="${note}" method="post">
            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID -->
            <input type="hidden" th:field="*{id}">

            <div class="mb-3">
                <label for="title" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="title" th:field="*{title}"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏" required>
                    <button type="button" class="btn btn-outline-info" onclick="generateTitle()">
                        ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <label for="content" class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:</label>
                <textarea class="form-control" id="content" th:field="*{content}"
                          rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏" required></textarea>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="autocompleteText()">
                        ‚úçÔ∏è –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="improveText()">
                        ‚ú® –£–ª—É—á—à–∏—Ç—å
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="summarizeNote()">
                        üìù –†–µ–∑—é–º–µ
                    </button>
                </div>
            </div>

            <div id="aiLoading" class="alert alert-info" style="display: none;">
                <span class="spinner-border spinner-border-sm" role="status"></span>
                AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å...
            </div>

            <div id="aiResult" class="alert alert-success" style="display: none;"></div>
            <div id="aiError" class="alert alert-danger" style="display: none;"></div>

            <div class="mb-3">
                <label for="weight" class="form-label">–í–µ—Å (–∫–≥):</label>
                <input type="number" step="0.1" class="form-control" id="weight"
                       th:field="*{weight}" placeholder="75.0">
                <div class="form-text">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</div>
            </div>

            <div class="mb-3">
                <label for="date" class="form-label">–î–∞—Ç–∞:</label>
                <input type="date" class="form-control" id="date" th:field="*{date}" required>
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="completed" th:field="*{completed}">
                    <label class="form-check-label" for="completed">
                        –ó–∞–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
                    </label>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a th:href="@{/}" class="btn btn-secondary me-md-2">–û—Ç–º–µ–Ω–∞</a>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const noteId = [[${note.id}]];

    function showLoading() {
        document.getElementById('aiLoading').style.display = 'block';
        document.getElementById('aiResult').style.display = 'none';
        document.getElementById('aiError').style.display = 'none';
    }

    function hideLoading() {
        document.getElementById('aiLoading').style.display = 'none';
    }

    function showResult(text) {
        hideLoading();
        document.getElementById('aiResult').style.display = 'block';
        document.getElementById('aiResult').textContent = text;
        document.getElementById('aiError').style.display = 'none';
    }

    function showError(error) {
        hideLoading();
        document.getElementById('aiError').style.display = 'block';
        document.getElementById('aiError').textContent = '–û—à–∏–±–∫–∞: ' + error;
        document.getElementById('aiResult').style.display = 'none';
    }

    async function callAI(endpoint, prompt) {
        showLoading();
        try {
            const response = await fetch('/api/ai/' + endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: prompt })
            });
            const data = await response.json();
            if (data.success) {
                return data.content;
            } else {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            showError(error.message);
            throw error;
        }
    }

    async function generateTitle() {
        const content = document.getElementById('content').value;
        if (!content.trim()) {
            showError('–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞');
            return;
        }
        try {
            const title = await callAI('title', content);
            document.getElementById('title').value = title;
            showResult('–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω!');
        } catch (error) {
            // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
        }
    }

    async function autocompleteText() {
        const content = document.getElementById('content').value;
        if (!content.trim()) {
            showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è');
            return;
        }
        try {
            const completed = await callAI('autocomplete', content);
            document.getElementById('content').value = content + ' ' + completed;
            showResult('–¢–µ–∫—Å—Ç –¥–æ–ø–æ–ª–Ω–µ–Ω!');
        } catch (error) {
            // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
        }
    }

    async function improveText() {
        const content = document.getElementById('content').value;
        if (!content.trim()) {
            showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
            return;
        }
        try {
            const improved = await callAI('improve', content);
            document.getElementById('content').value = improved;
            showResult('–¢–µ–∫—Å—Ç —É–ª—É—á—à–µ–Ω!');
        } catch (error) {
            // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
        }
    }

    async function summarizeNote() {
        try {
            const response = await fetch('/api/ai/notes/' + noteId + '/summarize');
            const data = await response.json();
            if (data.success) {
                showResult('–†–µ–∑—é–º–µ –∑–∞–º–µ—Ç–∫–∏:\n' + data.content);
            } else {
                showError(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑—é–º–µ');
            }
        } catch (error) {
            showError(error.message);
        }
    }
</script>
</body>
</html>

